<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <title>{{host.hostName}}学习任务</title>
    {% include "common/head.html"%}

    <style type="text/css">
        /*change the default*/
        .navbar {
            margin-bottom: 0;
        }

        iframe {
            display: block;       /* iframes are inline by default */
            border: none;         /* Reset default border */
            height: 100vh;        /* Viewport-relative units */
            width: 100vw;
            /*background:transparent;*/
            /*考虑到响应式，标题栏的高度应该是变化的，不展开时是64px*/
            padding:0 0 64px 0 !important;
        }

        .form-group {
            margin-top: 0;
            padding-bottom: 0;
        }
        .form-control, .radio label {
            font-size: 14px !important;
        }
        .bg{
            border: solid red;
        }
    </style>
</head>
<body style="margin:0;padding:0;overflow:hidden;">
{% include "common/navbar.html"%}

<!-- 用iframe直接加载网页遇到的问题：
1.如https://www.zhihu.com/服务器返回头问题，无法正常显示
2.如http://www.w3school.com.cn/，原网页缩小后就没有横向滚动条，所以嵌入iframe后也没有横线滚动条
3.如http://www.runoob.com/，原网页为响应式，缩小后自适应，也没有横向滚动条
4.如http://www.weibo.com/自带蒙版，点击iframe自动跳回原网页
5.比较正常网页如https://www.baidu.com/，https://www.taobao.com/  -->
<div style="position: relative">
    <iframe style="position: absolute;left: 0;top: 0;" class="col-md-8 col-xs-7" id="loadingIframe" src="{% url 'learningsystem:loading_iframe' %}"></iframe>
    <iframe id='pageiframe' sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-pointer-lock" style="position: absolute;left: 0;top: 0;" src="http://www.sddpf.org.cn/" class="col-md-8 col-xs-7" onload="mainIframeLoaded()">
        您的浏览器不支持iframe，请更新您的浏览器（推荐使用chrome浏览器）
    </iframe>
</div>

<div class="col-md-4 col-xs-5" style="overflow: auto; position: absolute; right: 0; top: 64px; bottom: 10px;">
    <div style="margin-top: 20px;" class="text-center">
        <a href="{{ page.url }}" target="_blank">
            <h4>
                {% if page.title %}
                    {{ page.title }}
                {% else %}
                    该网页没有标题
                {% endif %}
            </h4>
        </a>
    </div>
    <hr style="background: #777; opacity:0.2;">
    <div style="display: inline-block">
        <div id='item'  style="width: 40%;float: left;">
            <ul class="nav nav-pills nav-stacked text-left" style="background: #cddfe8" >
                <li class="active text-primary text-center" ><strong>学习条目</strong></li>
                <hr style="background: #777; opacity:0.2;">
                {#     {% for rule in rulelist %}#}
                <li><a href="#" onclick ="changeFrom();return false" id="change" >验证码（等级2）<i class="mdui-icon material-icons"  style="float: right ">&#xe5cc;</i></a></li>
                <li><a href="#" id="change{{ rule.ruleid }}"> 验证码（等级1）<i class="mdui-icon material-icons"  style="float: right ">&#xe5cc;</i></a></li>
                <li><a href="#" >非文本链接（等级1）<i class="mdui-icon material-icons"  style="float: right ">&#xe5cc;</i></a></li>
                <li><a href="#" >无障碍内容版本链接位置（等级1）<i class="mdui-icon material-icons"  style="float: right ">&#xe5cc;</i></a></li>
            </ul>
        </div>
        <div id='record' style="width: 55%;float: right">
            <div>
                <span class="text-primary">检测规则</span>
                <div  id="showRuleSpecific" class="togglebutton pull-right" style="display:inline-block;">
                    <label><input type="checkbox"></label>
                </div>
                <p style="margin-top: 5px;" class="text-muted" id="title">{{ rule.title }}</p>
            </div>
            <div id="ruleSpecific" hidden>
                <div>
                    <span class="text-primary">规则描述</span>
                    <p style="margin-top: 5px;" class="text-muted" id="description">{{rule.description}}</p>
                </div>
                <div style="margin-top: 10px;">
                    <span class="text-primary">检测方法</span>
                    <p style="margin-top: 5px;" class="text-muted" id="checkMethod">{{rule.checkMethod}}</p>
                </div>
                <div style="margin-top: 10px;">
                    <span class="text-primary">通过条件</span>
                    <p style="margin-top: 5px;" class="text-muted" id="passCondition">{{rule.passCondition}}</p>
                </div>
            </div>
            <hr style="background: #777; opacity:0.2;">
            <form role="form" style="margin-bottom: 10px;">
                <fieldset>
                    <div class="form-group" style="margin-top: 0;" id="checkResult">
                        <p class="control-label  text-primary">检测结果</p>
                        <div class="radio" style="display: inline-block;">
                            <label style="padding-left: 35px;"><input type="radio" name="radioCheckResult" value="1">通过</label>
                        </div>
                        <div class="radio" style="display: inline-block;">
                            <label style="padding-left: 35px;"><input type="radio" name="radioCheckResult" value="0" checked>不通过</label>
                        </div>
                        <div class="radio" style="display: inline-block;">
                            <label style="padding-left: 35px;"><input type="radio" name="radioCheckResult" value="3" >不知道</label>
                        </div>
                        <div class="radio" style="display: inline-block;">
                            <label style="padding-left: 35px;"><input type="radio" name="radioCheckResult" value="2" >不存在</label>
                        </div>
                    </div>
                    <div id="checkReason" style="margin-bottom: 40px;" >
                        <div class="form-group">
                            <label for="freqAns" class="control-label">常见不通过原因</label>
                             <div>
                                <select id="freqAns" class="form-control" placehoder="">
                                  <option>亲自写(自带清空技能)</option>
                                  <option>ddddddd</option>
                                   {% if rule.freqAns %}
        {#                                <c:set var="optionsFreqAns" value="{{fn.split({{rule.freqAns}}, '#F#G#F#')}}" />#}
        {#                                <c:forEach var="optionFreqAns" items="{{optionsFreqAns}}">#}
        {#                                    <option>{{optionFreqAns}}</option>#}
        {#                                </c:forEach>#}
                                   {% endif %}
                                </select>
                            </div>
                        </div>
                        <div class="form-group" id="formFailAns">
                            <label for="failAns" class="control-label">不通过原因</label>
                            <button type="button" id='autoGetAns' class="btn btn-btn-raised btn-primary  btn-sm" alt="按Enter键结束自动获取">自动获取</button>
                            <div>
                                <textarea class="form-control " rows="2" id="failAns" readonly="false"></textarea></div>
                                <span class="help-block">请务必给出不通过的原因(亲自写或自动获取)</span>
                        </div>
                    </div>
                   <div id="result" hidden>
                     <p class="text-primary">您的答案：<span class="text-muted" id="userResult"></span></p>
                     <p class="text-primary">您的理由：<span class="text-muted" id="userReason"></span></p>
                     <p class="text-primary">标准答案：<span class="text-muted" id="stdResult" >hhh</span></p>
                     <p class="text-primary" id="stdReason">原因：
                         <span class="text-muted">
                             hhhhhhhhh
                         </span>
                     </p>
                  </div>
                  <div class="form-group">
                        <button type="button" class="btn btn-raised btn-primary btn-block" id="btnSubmit" style="padding-top:10px; padding-bottom:10px;" >确定</button>
                  </div>
                </fieldset>
            </form>
            <input id="itemID" type="hidden" value="{{item_id}}" />
            <input id="reasonTag" type="hidden" value="0" />
        </div>
    </div>
    <hr style="background: #777; opacity:0.2;">
     <div >
         <button type="button" class="btn btn-raised btn-primary btn-block" id="next" style="padding-top:10px; padding-bottom:10px;margin-top: 30px" >下一个</button>
     </div>
</div>

{% include "common/footer.html"%}
<script type="text/javascript">

   $(function () {
    });
     $('footer').hide();
   //主iframe加载完成时将加载信息隐藏
    function mainIframeLoaded() {
      $('#loadingIframe').css('display', 'none');
    }

    // 规则折叠
    $('#showRuleSpecific').change(function() {
        $('#ruleSpecific').slideToggle();
    });

    //不通过原因折叠
    $('#checkResult').change(function() {
        var checkResult = $('input:radio[name="radioCheckResult"]:checked').val();
        if(checkResult==0) {
            $('#checkReason').slideDown();
            $('#failAns').attr("readOnly",false);
            $('#failAns').focus();
        }else{
            $('#checkReason').slideUp();
        }
    });
    var lastBlock; //记录上次框出的块
    var userfailReason;//实际不通过原因
      //常用不通过原因处理
    $('#freqAns').change(function() {
        $(document).off("click");
        $(lastBlock).removeClass('bg');
        $('#failAns').attr("placeholder",'');
        $('#failAns').attr("readOnly",false);
        if($('#freqAns').get(0).selectedIndex == 0) {  //亲自写
            $('#failAns').val('');
            $('#formFailAns').addClass('is-empty');
        } else{
            userfailReason=$('#freqAns option:selected').text();
            $('#failAns').val($('#freqAns option:selected').text());
            $('#formFailAns').removeClass('is-empty');
        }
          $('#failAns').focus();
          $('reasonTag').val(0);
    });

    $('#autoGetAns').click(function(){
         $('#failAns').attr("readOnly",true);
         $('#failAns').attr("placeholder",'按Enter键结束获取');
         $(document).click(function (e) {
             if(lastBlock){
                 $(lastBlock).removeClass('bg');
             }
            if($(e.target).attr('id')!='autoGetAns'){
                $(e.target).addClass('bg');     // 设置背景色
                $('reasonTag').val(1);
                $('#failAns').val('已获取');
                lastBlock=$(e.target);
                userfailReason=$(e.target).context.innerHTML;
            }
         })
    });
    document.onkeydown=function (e) {
          if(e && e.keyCode==13){ // enter 键结束自动获取
            $(document).off("click");
         }
       };

    function  showUserResult(userResult) { //用户结果转换
        if(userResult == 0) {
                $('#userResult').text('不通过');
            } else {
                if (userResult == 1) {
                    $('#userResult').text('通过');
                } else if (userResult == 2) {
                    $('#userResult').text('不存在');
                } else if (userResult == 3) {
                    $('#userResult').text('不知道');
                }
            }
    }
    function  showStdResult(stdResult) { //标准答案转换
        if(stdResult == 0) {
            $('#stdResult').text('不通过');
        }else if(stdResult == 1){
            $('#stdResult').text('通过');
        }else if (userResult == 2) {
            $('#userResult').text('不存在');
        }
    }

    $('#btnSubmit').click(function() {
        var checkResultInfo = {};
        var userResult = parseInt($('input:radio[name="radioCheckResult"]:checked').val());
        if(userResult == 0&&!$.trim($('#failAns').val())) {
                showModal('错误提示', '请给出不通过的的原因', '#failAns');
        }else {
            checkResultInfo["userResult"] = userResult;
            checkResultInfo["userFailReason"] = userfailReason;
            checkResultInfo["reason_tag"] = parseInt($('#reasonTag').val());
        //    console.log(checkResultInfo);
            showUserResult(userResult);
            if(userResult == 0){
               $('#userReason').text($.trim($('#failAns').val()));
            }else{
               $('#userReason').text('暂无原因');
            }
            {#$('#change'{{ rule.ruleid }}).css('color', 'red');#}
            $('#change').css('color', 'red');
            $("input[name='radioCheckResult']").attr('disabled', 'true');
            $('#btnSubmit').attr('disabled', 'true');
            $('#result').slideDown();
            {#$.ajax({#} //表单提交
            {#    type: 'POST',#}
            {#    url: '{% url '' %}',#}
            {#    data: checkResultInfo,#}
            {#    async:false,#}
            {#    success:function (result) {#}
            {#        result = JSON.parse(result);#}
            {#        if (result["resultStatus"] == "FAIL") {#}
            {#         showModal("错误提示", result.resultMsg, '');#}
            {#        }#}
            {#    }#}
            {#}); #}
        }
    });

     function changeFrom(){
           var itemID = $('#itemID').val();
           {#var ruleid={{ rule.ruleid }};#}
           $.ajax({     //获取学习记录
                type: 'POST',
                {#url: '{% url ''itemID ruleid %}',#}
                async:false,
                success:function (result) {
                    result = JSON.parse(result);
                    $('#title').text(result.title); //检测规则
                    $('#description').text(result.description);
                    $('#checkMethod').text(result.checkMethod);
                    $('#passCondition').text(result.passCondition);
                    if(!result.user_result){
                        $("input[name='radioCheckResult']").attr('disabled', 'true');
                        $('#checkResult').attr('disabled','true');
                        $('#btnSubmit').attr('disabled','true');
                        $('#result').slideDown();
                        $('#userReason').text(result.userReason); //检测结果
                        $('#stdReason').text(result.stdReason);
                        showRealResult(result.user_result );
                        showStdResult(result.std_result);
                    }
                }
            });
     }
</script>
</body>
</html>